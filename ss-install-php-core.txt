#!/bin/bash

####################################################################################################
#### author: SlickStack ############################################################################
#### link: https://slickstack.io ###################################################################
#### mirror: http://mirrors.slickstack.io/ss-install-php-core.txt ##################################
#### path: /var/www/ss-install-php-core ############################################################
#### destination: n/a (not a boilerplate) ##########################################################
#### purpose: Reinstalls the PHP-FPM module Ubuntu packages and extensions (idempotent) ############
#### module version: PHP-FPM 7.4.x #################################################################
#### sourced by: ss-install, ss-install-php ########################################################
####################################################################################################

## SS-CONFIG MUST BE PROPERLY CONFIGURED (AND CURRENT BUILD) BEFORE RUNNING SS-INSTALL ##
## ENSURE SS-CONFIG OPTIONS REMAIN CURRENT BY RUNNING SS-UPDATE OCCASIONALLY ##

## include SlickStack configuration ##
source /var/www/ss-config

## include SlickStack functions ##
source /var/www/ss-functions

####################################################################################################
#### SS-Install-PHP: Cleanup Temporary Files #######################################################
####################################################################################################

## delete tmp files ##
# n/a

####################################################################################################
#### SS-Install-PHP: Backup Database Before Proceeding #############################################
####################################################################################################

## run ss-dump-database ##
source /var/www/ss-dump-database

####################################################################################################
#### SS-Install-PHP: Purge + Cleanup Any Existing PHP Packages #####################################
####################################################################################################

## here we first purge any existing PHP packages and then reinstall PHP-FPM from scratch ##
## this approach is safe and helps avoid any conflicts between package versions ##

## purge packages ##
apt purge ^php

## delete any leftover PHP files (disable for now because apt will not create these files if it notices the php directory exists already) ##
# rm /etc/php*

## cleanup any outdated packages and system files ##
apt autoremove
apt autoclean

## update repo cache ##
apt update

####################################################################################################
#### SS-Install-PHP: Install PHP-FPM + PHP Extensions ##############################################
####################################################################################################

## here PHP-FPM will be installed along with any custom PHP extensions in your ss-config ##
## remember to check version compatibility of PHP extensions if you modify them ##

## install php-fpm (php7.x not needed when php7.x-fpm installed) ##
# if [[ "${UBUNTU_VERSION}" = "20.04" ]] && [[ -n "$PHP_EXTENSIONS" ]]; then
if [[ "${UBUNTU_VERSION}" = "20.04" ]]; then
    # apt install "$PHP_EXTENSIONS"
    apt install php7.4-fpm php7.4-bcmath php7.4-curl php7.4-gd php7.4-imagick php7.4-json php7.4-mbstring php7.4-mysql php7.4-soap php7.4-xml php7.4-zip
fi

if [[ "${UBUNTU_VERSION}" = "18.04" ]]; then
    apt install php7.2-fpm php7.2-bcmath php7.2-curl php7.2-gd php7.2-imagick php7.2-json php7.2-mbstring php7.2-mysql php7.2-soap php7.2-xml php7.2-zip
fi

## install php-redis (required) ##
if [[ "${UBUNTU_VERSION}" = "20.04" ]]; then
    apt install php-redis
fi

if [[ "${UBUNTU_VERSION}" = "18.04" ]]; then
    apt install php-redis
fi

####################################################################################################
#### SS-Install-PHP: Install (Optimize) PHP-FPM Configuration Files ################################
####################################################################################################

## run ss-install-php-config ##
source /var/www/ss-install-php-config

####################################################################################################
#### SS-Install-PHP:  #######################
####################################################################################################

## make PHP 7.4 the default version ##
if [[ "${UBUNTU_VERSION}" = "20.04" ]]; then
    update-alternatives --set php /usr/bin/php7.4
fi

## make PHP 7.2 the default version if server is running Ubuntu 18.04 ##
if [[ "${UBUNTU_VERSION}" = "18.04" ]]; then
    update-alternatives --set php /usr/bin/php7.2
fi

####################################################################################################
#### SS-Install-PHP: Reset Permissions (PHP-FPM) ###################################################
####################################################################################################

## run ss-perms-php ##
source /var/www/ss-perms-php

####################################################################################################
#### SS-Install-PHP: Purge Cache (PHP OPcache) #####################################################
####################################################################################################

## run ss-purge-opcache ##
source /var/www/ss-purge-opcache

####################################################################################################
#### SS-Install-PHP: Restart Services (PHP) ########################################################
####################################################################################################

## restart services ##
/etc/init.d/php*-fpm restart

####################################################################################################
#### SS-Install-PHP: Cleanup Temporary Files #######################################################
####################################################################################################

## delete tmp files ##
# n/a

####################################################################################################
#### SS-Install-PHP: Touch Timestamp File (End Of Script) ##########################################
####################################################################################################

## this is a dummy timestamp file that will remember the last time this script was run ##
## it can be useful for developer reference and is sometimes used by SlickStack ##

## script timestamp ##
touch /var/www/meta/.timestamp-ss-install-php-core

####################################################################################################
#### SlickStack: External References Used To Improve This Script (Thanks, Interwebz) ###############
####################################################################################################

## Ref:

## SS_EOF
